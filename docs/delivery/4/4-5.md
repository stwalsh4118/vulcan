# 4-5 CNI Networking Setup

[Back to task list](./tasks.md)

## Description

Implement CNI-based networking for Firecracker microVMs. Each VM gets a TAP device via the `tc-redirect-tap` CNI plugin (standard approach used by Kata Containers and the firecracker-go-sdk). This task handles CNI configuration generation, network setup per VM, IP allocation, outbound NAT, and cleanup on VM teardown.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:03 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 10:05:42 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 10:22:51 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 04:40:03 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **CNI configuration** (`internal/backend/firecracker/network.go`):
   - Generate CNI conflist for Firecracker: bridge plugin → tc-redirect-tap.
   - Bridge: `fcbr0` with subnet (e.g., `10.168.0.0/24`), gateway `10.168.0.1`.
   - tc-redirect-tap: converts veth pair into TAP device for Firecracker.
   - Write conflist to configured CNI config directory.

2. **NetworkManager type**:
   - `Setup(ctx context.Context, vmID string) (*NetworkConfig, error)` — create network namespace, invoke CNI ADD, return TAP device name + guest IP.
   - `Teardown(ctx context.Context, vmID string) error` — invoke CNI DEL, remove namespace, clean up.
   - `NetworkConfig` struct: TAP device name, guest IP, gateway IP, MAC address, namespace path.

3. **Network namespace management**:
   - Create per-VM network namespace (`/var/run/netns/vulcan-<vmID>`).
   - Use `containernetworking/cni` library for CNI invocation within the namespace.
   - Clean up namespace on teardown.

4. **Outbound NAT**:
   - Configure nftables/iptables masquerade rule for the bridge subnet.
   - Enable IP forwarding (`/proc/sys/net/ipv4/ip_forward`).
   - Idempotent: only add rules if not already present.

5. **Cleanup guarantees**:
   - Teardown must be called even if VM execution fails.
   - If teardown fails, log the error but don't block workload completion.
   - Track allocated IPs/namespaces for cleanup on server shutdown.

6. **CNI plugin verification**:
   - `Verify() error` — check that required CNI plugins (`bridge`, `tc-redirect-tap`) exist in the configured bin directory.
   - Called at backend startup; log warning if plugins missing.

## Implementation Plan

1. Create `api/internal/backend/firecracker/network.go`.
2. Implement CNI conflist generation.
3. Implement `NetworkManager` with `Setup` and `Teardown`.
4. Implement NAT rule management.
5. Implement plugin verification.
6. Integration tests (require root and CNI plugins installed).

**External Packages**: This task requires research and a guide document for: `containernetworking/cni`

## Test Plan

### Objectives
Verify network setup/teardown lifecycle works correctly per VM.

### Test Scope
- CNI conflist generation (correct JSON structure)
- Network namespace creation and cleanup
- NAT rule idempotency
- Plugin verification (present and absent cases)

### Mocking Strategy
- Unit tests: mock CNI library calls, verify conflist JSON structure
- Integration tests: require root + CNI plugins; create real namespace + TAP device

### Key Scenarios
1. Setup: create namespace, invoke CNI, return TAP + IP → verify namespace exists, TAP created
2. Teardown: invoke CNI DEL, remove namespace → verify namespace gone
3. Double teardown: second call is no-op (no error)
4. Plugin verification: plugins present → success; plugin missing → descriptive error
5. NAT rules: first call adds rule; second call is idempotent

### Success Criteria
- TAP devices created with correct configuration
- Namespaces cleaned up on teardown
- No leaked resources after error scenarios

## Verification

- All 22 network-specific tests pass with `-race` flag (conflist generation, CNI validation, plugin verification, conflist writing, teardown idempotency, MAC generation, namespace deletion, parseResult valid/no-IPs/no-sandbox/no-gateway, IP forwarding path)
- Full project suite passes: `go vet` clean, all 38 firecracker package tests pass
- AI review: initial verdict blocked (1 high: missing IP forwarding) — fixed:
  - Fixed: Added `EnsureIPForwarding()` for idempotent `/proc/sys/net/ipv4/ip_forward` management
  - Fixed: Replaced `os.IsNotExist` with `errors.Is(err, os.ErrNotExist)` in Verify() and deleteNetNS()
  - Fixed: Cached confListBytes on NetworkManager struct to avoid duplicate generation
  - Fixed: Replaced custom `contains` helper with `strings.Contains`
  - Fixed: Added parseResult unit tests (valid, no-IPs, no-sandbox, no-gateway)
  - Fixed: Added TAP device validation in parseResult
- Post-review fix: parseResult skips veth (CNIIfName) to find actual TAP device from tc-redirect-tap

## Files Modified

- `api/internal/backend/firecracker/network.go` — NetworkManager, conflist generation, Setup/Teardown, namespace management, plugin verification, EnsureIPForwarding, GenerateMAC
- `api/internal/backend/firecracker/network_test.go` — 22 unit tests covering all networking functionality
- `api/go.mod` — Added `github.com/containernetworking/cni v1.2.3` direct dependency
- `api/go.sum` — Updated checksums
- `docs/delivery/4/4-5-cni-guide.md` — CNI library research guide (containernetworking/cni)
