# 4-8 Frontend microVM Enhancements

[Back to task list](./tasks.md)

## Description

Enhance the frontend to better support Firecracker microVM workloads. Add file/archive upload support for submitting code as tar.gz archives (in addition to existing inline code), and display microVM-specific metadata (boot time, VM ID) in the workload detail view when available. Ensure the "microvm" isolation mode displays correctly in the UI when the Firecracker backend is registered.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:03 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 10:47:50 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 11:00:45 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 04:40:03 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Archive upload** (workload submission form):
   - Add a file input (drag-and-drop zone) for `.tar.gz` archive upload alongside the existing code editor.
   - Toggle between "Inline Code" and "Upload Archive" modes.
   - When archive mode is selected, hide the code editor and show the file input.
   - Read the file as base64 and send as the `code` field (with a prefix marker, e.g., `base64:...`), or add a new `code_archive` field to the API request body.
   - Show file name and size after selection.
   - Validate file type (only .tar.gz accepted) and size (max 10MB).

2. **API extension** (Go backend):
   - Extend `POST /v1/workloads` and `POST /v1/workloads/async` to accept a `code_archive` field (base64-encoded tar.gz).
   - If `code_archive` is provided, it takes precedence over `code`.
   - Pass archive data through to the backend's `WorkloadSpec` (add `CodeArchive []byte` field).
   - Update the `WorkloadSpec` struct in `internal/backend/backend.go`.
   - Update API spec.

3. **Workload detail metadata**:
   - If the workload ran on the `microvm` isolation mode, show a "microVM Details" section in the detail view.
   - Display: isolation mode badge, runtime badge.
   - Future-proofed: when the backend populates metadata fields (boot time, VM ID), they'll display automatically.

4. **Backend list display**:
   - Verify the `/v1/backends` response correctly shows the Firecracker backend with its capabilities.
   - Ensure the workload form's isolation dropdown shows "microvm" with a descriptive label (e.g., "MicroVM (Firecracker)").

## Implementation Plan

1. Add `CodeArchive []byte` field to `WorkloadSpec` in `internal/backend/backend.go`.
2. Update API handlers to parse `code_archive` from request body.
3. Update API spec documentation.
4. Add archive upload UI component to the workload submission form.
5. Add inline/archive mode toggle.
6. Add microVM metadata section to workload detail view.
7. Verify backend list display with Firecracker registered.

## Test Plan

- **Archive upload UI**: Verify file input appears in archive mode, accepts .tar.gz, rejects other types, shows file info.
- **API extension**: POST with `code_archive` field → verify accepted and passed to backend spec.
- **Mode toggle**: Switch between inline and archive → verify correct input shown, other hidden.
- **Detail view**: Workload with isolation=microvm → verify metadata section renders.
- **Backend list**: With Firecracker registered → verify it appears in the isolation dropdown.
- **Playwright verification**: Submit workload via archive upload (if backend available) or inline code with microvm isolation.

## Verification

- `go vet ./...` — clean
- `go test -race ./...` — all packages pass (6 new tests for code_archive validation)
- `pnpm tsc --noEmit` — no type errors
- `pnpm run lint` — clean
- Internal AI review: pass (0 critical, 0 high, 2 medium doc fixes applied, 5 low)

## Files Modified

- `api/internal/api/workload.go` — Added `errValidation` sentinel, `CodeArchive` field to request, `maxBodySize` to 15MB, `parseCodeFields` call
- `api/internal/api/async.go` — Added `gzipMagic`, `parseCodeFields` call and shared helper
- `api/internal/api/workload_test.go` — Added 6 tests for code_archive validation (sync + async)
- `api/internal/backend/backend.go` — Added `CodeArchive []byte` to `WorkloadSpec`
- `api/internal/engine/engine.go` — Pass `Code`/`CodeArchive` through to `WorkloadSpec`
- `api/internal/model/workload.go` — Added transient `Code`/`CodeArchive` fields (`json:"-"`)
- `web/src/app/workloads/new/page.tsx` — Archive upload with mode toggle, drag-and-drop, isolation labels
- `web/src/app/workloads/[id]/page.tsx` — MicroVM details section
- `web/src/lib/types.ts` — Added `code_archive` to `CreateWorkloadRequest`
- `docs/api-specs/core/core-api.md` — Updated spec with code_archive, Firecracker metrics, WorkloadSpec
