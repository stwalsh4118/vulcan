# 4-9 E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end tests that verify all PBI 4 acceptance criteria. These tests exercise the full stack: frontend submission → API → engine → Firecracker backend → microVM boot → guest agent execution → result return → frontend display. Requires a host with KVM support and Firecracker binary + kernel + rootfs images available.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:03 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify each PBI 4 acceptance criterion:

1. **AC1**: Firecracker backend implements the `Backend` interface from PBI-2.
   - Verify backend registers with registry and resolves for `microvm` isolation.
   - Verify `Capabilities()` returns correct runtimes and isolation modes.

2. **AC2**: MicroVMs boot successfully with the pre-built kernel and rootfs images.
   - Submit a workload → verify VM boots (check logs for boot messages).
   - Verify boot completes within reasonable time (<5s).

3. **AC3**: CNI networking creates TAP devices and provides connectivity.
   - Submit a workload that makes a network request from inside the VM (e.g., `curl` or `wget` to host).
   - Verify network connectivity exists during execution.
   - Verify TAP device is cleaned up after completion.

4. **AC4**: Guest agent receives workload code over vsock and returns execution results.
   - Submit inline code → verify output matches expected result.
   - Verify exit code is propagated correctly (0 for success, non-zero for failure).

5. **AC5**: Go, Node, and Python workloads execute correctly inside microVMs.
   - Submit Go workload (`fmt.Println("hello from go")`) → verify output.
   - Submit Node workload (`console.log("hello from node")`) → verify output.
   - Submit Python workload (`print("hello from python")`) → verify output.

6. **AC6**: Resource limits (vCPUs, memory, timeout) are enforced per workload.
   - Submit workload with 1 vCPU, 64MB memory → verify VM configured with those limits.
   - Submit workload with 5s timeout, code that sleeps for 10s → verify killed after timeout.

7. **AC7**: VMs are cleaned up after workload completion or failure.
   - After successful workload: verify no lingering VM process, TAP device, or network namespace.
   - After failed workload: same cleanup verification.
   - After killed workload: same cleanup verification.

8. **AC8**: A user can submit a microVM workload from the frontend, watch it execute, and see the result.
   - Playwright test: navigate to submission form, select microvm isolation, enter code, submit.
   - Verify redirect to detail page, status progression (pending → running → completed).
   - Verify output displayed in the detail view.
   - Verify log lines streamed during execution.

9. **AC9**: Prometheus metrics include Firecracker-specific stats.
   - After executing a workload, scrape `/metrics`.
   - Verify `vulcan_firecracker_vm_boot_seconds` has observations.
   - Verify `vulcan_firecracker_active_vms` was incremented and decremented.
   - Verify `vulcan_firecracker_workloads_total` has correct labels.

## Implementation Plan

1. Create test file(s) in `api/test/` for backend-level E2E tests.
2. Create Playwright test(s) in `web/e2e/` for frontend E2E tests.
3. Add test setup: start server with real Firecracker backend (skip if KVM unavailable).
4. Implement each acceptance criterion as a named test case.
5. Add cleanup verification helpers (check for lingering processes, TAP devices, namespaces).
6. Document KVM/Firecracker prerequisites for running tests.

## Test Plan

### Objectives
Verify all 9 acceptance criteria for PBI 4 pass end-to-end.

### Environment & Setup
- Host with KVM support (`/dev/kvm` accessible).
- Firecracker binary, kernel, and rootfs images built (via Task 4-3 tooling).
- API server running with Firecracker backend registered.
- Frontend dev server running (for Playwright tests).

### Test Categories
1. **API-level E2E** (Go tests): AC1-AC7, AC9 — submit workloads via HTTP, verify results.
2. **Frontend E2E** (Playwright): AC8 — submit and monitor via browser.

### Success Criteria
- All 9 acceptance criteria pass.
- No resource leaks detected after test suite completes.
- Tests are skippable on hosts without KVM support (build tag or env check).

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
