# 4-2 Guest Agent Binary

[Back to task list](./tasks.md)

## Description

Build the `vulcan-guest` binary — a small, statically compiled Go program that runs as an init process (or early service) inside Firecracker microVMs. It listens on a vsock connection, receives workload specifications from the host, executes the code using the appropriate runtime, captures stdout/stderr, and returns execution results back to the host over vsock.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:03 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 09:43:09 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 09:54:58 | Status Change | InProgress | Review | Implementation complete, internal AI review passed (after fixing critical/high findings) | AI_Agent |
| 2026-02-20 04:40:03 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Binary location**: `api/cmd/vulcan-guest/main.go`
2. **Static compilation**: Must build with `CGO_ENABLED=0 GOOS=linux GOARCH=amd64` for Alpine rootfs compatibility.
3. **vsock listener**: Listen on `VSOCK_ANY_CID` with the configured port (default 1024) using the `mdlayher/vsock` package or equivalent.
4. **Protocol**: Use the length-prefixed JSON framing defined in Task 4-1.
   - Receive `GuestRequest` from host.
   - Send `GuestResponse` to host.
   - Support streaming log lines back during execution (line-by-line JSON messages).
5. **Code extraction**:
   - Write `GuestRequest.Code` to `/work/<entrypoint>` (e.g., `/work/main.go`).
   - If code is base64-encoded archive (tar.gz), extract to `/work/`.
   - Set appropriate file permissions.
6. **Runtime dispatch**:
   - `go`: `go run /work/main.go` (or `go build && ./main` for multi-file).
   - `node`: `node /work/index.js`
   - `python`: `python3 /work/main.py`
   - Entrypoint filename derived from runtime if not specified in request.
7. **stdout/stderr capture**: Capture both streams. Send each line as a log message back to host over vsock in real time.
8. **Timeout enforcement**: Guest-side backup timeout from `GuestRequest.Timeout`. Kill child process on timeout expiry.
9. **Exit code propagation**: Capture child process exit code and return in `GuestResponse`.
10. **Error handling**: If runtime not found or code fails to extract, return error in `GuestResponse` without crashing the agent (agent should stay alive for potential retries).
11. **Init mode**: If running as PID 1, mount essential filesystems (`/proc`, `/sys`, `/dev`) and set up minimal environment.

## Implementation Plan

1. Create `api/cmd/vulcan-guest/main.go`.
2. Implement vsock listener using `mdlayher/vsock` package.
3. Implement request/response handling using protocol types from Task 4-1.
4. Implement code extraction (inline string to file, base64 archive to directory).
5. Implement runtime dispatch with configurable entrypoints.
6. Implement stdout/stderr streaming via vsock log messages.
7. Implement timeout enforcement with process kill.
8. Implement init mode (filesystem mounts, environment setup).
9. Add Makefile target for static build: `make build-guest`.

**External Packages**: This task requires research and a guide document for: `mdlayher/vsock` (or `golang.org/x/sys/unix` with raw vsock support)

## Test Plan

### Objectives
Verify the guest agent correctly handles workload execution lifecycle.

### Test Scope
- Protocol message handling (receive request, send response)
- Code extraction (inline code, archive extraction)
- Runtime dispatch (correct command per runtime)
- stdout/stderr capture and log streaming
- Timeout enforcement (process killed on timeout)
- Error handling (invalid runtime, extraction failure)

### Mocking Strategy
- Mock vsock connection with in-memory net.Conn (or Unix socket for integration tests)
- Test code execution with simple scripts (echo, sleep, exit-code)

### Key Scenarios
1. Receive Go workload → extract → run → return output + exit code 0
2. Receive Node workload → extract → run → return output + exit code 0
3. Receive Python workload → extract → run → return output + exit code 0
4. Workload exceeds timeout → process killed → error returned
5. Invalid runtime → error response without agent crash
6. Code extraction failure → error response without agent crash
7. Streaming: multi-line output → each line sent as log message

### Success Criteria
- All supported runtimes execute correctly
- Timeout kills process and returns error
- Agent remains alive after error scenarios

## Verification

- All 16 tests pass with `-race` flag (Go, Node, Python runtimes; timeout; non-zero exit; multi-line; archive; path traversal; resilience)
- `go vet` clean, `golangci-lint` 0 issues
- Full project test suite passes
- AI review: initial verdict blocked (1 critical, 2 high) — all resolved:
  - Fixed: concurrent conn writes now protected by sync.Mutex
  - Fixed: entrypoint path traversal validation added
  - Fixed: replaced shell `tar` with Go archive/tar for safe extraction with zip-slip guard
- Medium findings addressed: Go runtime test added, archive e2e test added, agent resilience test added
- Deferred: stdout/stderr stream differentiation (requires protocol extension — documented as follow-up)
- `make build-guest` Makefile target deferred to task 4-3 (build tooling)

## Files Modified

- `api/cmd/vulcan-guest/main.go` — Guest agent entry point with vsock listener
- `api/internal/guest/agent.go` — Core agent logic: connection handling, code extraction, runtime dispatch, log streaming, timeout enforcement
- `api/internal/guest/init.go` — PID 1 init mode: /proc, /sys, /dev mounts
- `api/internal/guest/agent_test.go` — 16 tests covering all runtime, error, security, and resilience scenarios
- `api/internal/backend/firecracker/protocol.go` — Added GuestMessage envelope type and MsgTypeLog/MsgTypeResult constants for streaming
- `api/go.mod` — Added github.com/mdlayher/vsock dependency
- `docs/delivery/4/4-2-vsock-guide.md` — External package research guide
