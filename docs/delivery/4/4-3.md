# 4-3 Kernel & Rootfs Build Tooling

[Back to task list](./tasks.md)

## Description

Create the tooling to download the Firecracker binary and a compatible Linux kernel, and to build ext4 rootfs images for each supported runtime (Go, Node, Python). Each rootfs is an Alpine-based ext4 image containing the runtime, the `vulcan-guest` agent binary, and minimal init configuration. Version pinning ensures reproducible builds.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:03 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 09:55:39 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 10:01:13 | Status Change | InProgress | Review | Implementation complete, internal AI review passed (3 high findings fixed) | AI_Agent |
| 2026-02-20 04:40:03 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Download script** (`tools/firecracker/download.sh`):
   - Download Firecracker binary (pinned version, e.g., v1.7.0).
   - Download Firecracker-compatible Linux kernel (5.10+ from Firecracker's official releases).
   - Verify checksums (SHA256).
   - Place binaries in `tools/firecracker/bin/`.
   - Idempotent — skip download if correct version already present.

2. **Makefile** (`tools/firecracker/Makefile`):
   - `make download` — run download script.
   - `make guest` — build `vulcan-guest` static binary (CGO_ENABLED=0).
   - `make rootfs-go` — build Go runtime rootfs.
   - `make rootfs-node` — build Node runtime rootfs.
   - `make rootfs-python` — build Python runtime rootfs.
   - `make rootfs-all` — build all rootfs images.
   - `make clean` — remove built artifacts.
   - Output images to `tools/firecracker/images/`.

3. **Rootfs build process** (per runtime):
   - Create empty ext4 image (e.g., 512MB).
   - Mount the image and bootstrap Alpine Linux minimal root.
   - Install runtime packages: `go` (for Go), `nodejs` (for Node), `python3` (for Python).
   - Copy `vulcan-guest` binary to `/usr/local/bin/vulcan-guest`.
   - Create `/work` directory.
   - Configure init: `/sbin/init` → symlink or script that starts `vulcan-guest`.
   - Unmount and finalize image.
   - Name format: `go.ext4`, `node.ext4`, `python.ext4`.

4. **Version pinning**:
   - `FIRECRACKER_VERSION` variable in Makefile/download script.
   - `KERNEL_VERSION` variable.
   - Runtime versions documented (Alpine package versions).

5. **Prerequisites documentation** (`tools/firecracker/README.md`):
   - Required host tools: `dd`, `mkfs.ext4`, `mount`, `apk` (or Alpine minirootfs approach).
   - Required privileges: root/sudo for mount operations (or fakeroot alternative).
   - KVM support: `/dev/kvm` must be accessible.

## Implementation Plan

1. Create `tools/firecracker/` directory structure.
2. Write `download.sh` with version-pinned downloads and checksum verification.
3. Write rootfs build script (`build-rootfs.sh`) that takes a runtime name and produces an ext4 image.
4. Write `Makefile` with all targets.
5. Write `README.md` with prerequisites and usage instructions.
6. Test the full build pipeline: download → build guest → build rootfs → verify images contain expected files.

## Test Plan

- **Download script**: Run download, verify binaries exist at expected paths with correct versions (`firecracker --version`).
- **Guest binary build**: Verify static binary is produced (`file vulcan-guest` shows "statically linked").
- **Rootfs images**: Mount each image and verify:
  - `/usr/local/bin/vulcan-guest` exists and is executable.
  - Runtime binary exists and is functional (`go version`, `node --version`, `python3 --version`).
  - `/work` directory exists.
  - Init configuration points to guest agent.
- **Idempotency**: Run download twice, verify no re-download occurs.

## Verification

- `make guest` produces statically linked ELF binary (verified with `file`)
- `make verify` correctly reports artifact status
- All Go tests still pass across the full project
- AI review: initial verdict blocked (3 high) — all resolved:
  - Fixed: kernel URL now uses FC_KERNEL_COMPAT derived from FIRECRACKER_VERSION
  - Fixed: kernel version idempotency via sidecar version file
  - Fixed: Makefile uses stamp file pattern to prevent parallel download races
  - Fixed: build-rootfs.sh copies resolv.conf for DNS in chroot
  - Fixed: build-rootfs.sh uses ALPINE_TMPDIR to avoid shadowing POSIX TMPDIR
  - Fixed: partial images cleaned up on failure via trap
- Download and rootfs build require network and root — verified script correctness manually
- Post-review fix: download.sh kernel URL resolution via S3 bucket listing (vmlinux-5.10 → vmlinux-5.10.233)
- Post-review fix: build-rootfs.sh bind-mount /proc, /sys, /dev for chroot apk on Arch Linux; use absolute /sbin/apk path

## Files Modified

- `tools/firecracker/download.sh` — Firecracker binary and kernel downloader with checksum verification
- `tools/firecracker/build-rootfs.sh` — Alpine-based ext4 rootfs builder per runtime
- `tools/firecracker/Makefile` — Build orchestration with all required targets
- `tools/firecracker/README.md` — Prerequisites, usage, version pins documentation
- `tools/firecracker/.gitignore` — Exclude bin/ and images/ from version control
