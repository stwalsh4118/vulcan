# 4-1 Firecracker Configuration, Types & Protocol

[Back to task list](./tasks.md)

## Description

Define all configuration structures, environment variables, vsock protocol types, and named constants required by the Firecracker microVM backend. This foundational task establishes the shared vocabulary used by subsequent tasks (guest agent, vsock communication, CNI networking, and the core backend).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:03 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 09:36:14 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 09:42:37 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 04:40:03 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Config struct** (`internal/backend/firecracker/config.go`):
   - `KernelPath` — path to the Firecracker-compatible kernel image
   - `RootfsDir` — directory containing runtime-specific rootfs images
   - `FirecrackerBin` — path to the Firecracker binary
   - `CNIConfigDir` — path to CNI configuration directory
   - `CNIBinDir` — path to CNI plugin binaries
   - `VsockPort` — guest agent vsock port (default 1024)
   - `CIDBase` — starting context ID for vsock (default 3, CID 0-2 are reserved)
   - `JailerEnabled` — whether to use the Firecracker jailer (default false)
   - `DefaultVCPUs` — default vCPU count (default 1)
   - `DefaultMemMB` — default memory in MB (default 128)

2. **Environment variable loading** via `LoadConfig()`:
   - `VULCAN_FC_KERNEL_PATH`
   - `VULCAN_FC_ROOTFS_DIR`
   - `VULCAN_FC_BIN`
   - `VULCAN_FC_CNI_CONFIG_DIR`
   - `VULCAN_FC_CNI_BIN_DIR`
   - `VULCAN_FC_VSOCK_PORT`
   - `VULCAN_FC_JAILER`

3. **vsock protocol types** (`internal/backend/firecracker/protocol.go`):
   - `GuestRequest` — JSON struct sent host→guest: runtime, code, input, env, entrypoint, timeout
   - `GuestResponse` — JSON struct sent guest→host: exit_code, output, error, log_lines
   - Length-prefixed framing: 4-byte big-endian length prefix followed by JSON payload

4. **Named constants** (`internal/backend/firecracker/constants.go`):
   - Default vsock port: `DefaultVsockPort = 1024`
   - Minimum CID: `MinCID = 3`
   - Default vCPUs: `DefaultVCPUs = 1`
   - Default memory: `DefaultMemMB = 128`
   - Supported runtimes: `SupportedRuntimes = []string{"go", "node", "python"}`
   - Rootfs filename pattern: `RootfsFilename = "%s.ext4"` (e.g., `go.ext4`)
   - Guest work directory: `GuestWorkDir = "/work"`
   - Guest agent binary path: `GuestAgentPath = "/usr/local/bin/vulcan-guest"`

5. **Runtime-to-rootfs mapping** — function that resolves a runtime string to the correct rootfs image path.

## Implementation Plan

1. Create `api/internal/backend/firecracker/` package directory.
2. Create `constants.go` with all named constants.
3. Create `config.go` with `Config` struct and `LoadConfig()` function.
4. Create `protocol.go` with `GuestRequest`, `GuestResponse` structs and framing helpers (`WriteMessage`, `ReadMessage`).
5. Unit tests for config loading (defaults and env overrides) and protocol framing (round-trip encode/decode).

## Test Plan

- **Config loading**: Verify defaults are applied when no env vars set. Verify each env var overrides the corresponding field.
- **Protocol framing**: Round-trip test — write a `GuestRequest`, read it back, verify equality. Same for `GuestResponse`.
- **Runtime-to-rootfs mapping**: Verify correct path for each supported runtime. Verify error for unsupported runtime.

## Verification

- All 16 tests pass with `-race` flag
- `go vet` clean
- `golangci-lint` 0 issues
- Full project test suite passes
- AI review: pass (0 critical, 0 high, 0 medium, 5 low — all addressed or documented)
- Low findings addressed: filepath.Join for path construction, MaxMessageSize guard on ReadMessage

## Files Modified

- `api/internal/backend/firecracker/constants.go` — Named constants, SupportedRuntimes, RootfsPath()
- `api/internal/backend/firecracker/config.go` — Config struct and LoadConfig()
- `api/internal/backend/firecracker/protocol.go` — GuestRequest, GuestResponse, WriteMessage, ReadMessage
- `api/internal/backend/firecracker/constants_test.go` — Tests for RootfsPath
- `api/internal/backend/firecracker/config_test.go` — Tests for LoadConfig defaults and env overrides
- `api/internal/backend/firecracker/protocol_test.go` — Tests for protocol framing round-trips and error cases
