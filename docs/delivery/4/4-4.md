# 4-4 vsock Host-Side Communication

[Back to task list](./tasks.md)

## Description

Implement the host-side vsock client library that communicates with the guest agent running inside a Firecracker microVM. This layer handles connecting to the guest via vsock, sending workload specifications, receiving execution results, and streaming log lines back to the engine's LogWriter callback in real time.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:03 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 10:01:50 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 10:05:08 | Status Change | InProgress | Review | Implementation complete, internal AI review passed (critical finding fixed) | AI_Agent |
| 2026-02-20 04:40:03 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **vsock client** (`internal/backend/firecracker/vsock.go`):
   - `DialGuest(ctx context.Context, cid uint32, port uint32) (*GuestConn, error)` — establish vsock connection to guest.
   - Uses `mdlayher/vsock` package (same as guest side) or Firecracker SDK's vsock connector.

2. **GuestConn type**:
   - `SendWorkload(req GuestRequest) error` — send workload spec using length-prefixed JSON framing.
   - `ReceiveResult() (GuestResponse, error)` — read result using length-prefixed framing.
   - `StreamLogs(logWriter func(string)) error` — read streaming log lines from guest and invoke LogWriter callback for each line.
   - `Close() error` — clean up connection.

3. **Protocol flow**:
   - Host sends `GuestRequest` (single message).
   - Guest streams log lines as individual messages (type-tagged JSON).
   - Guest sends final `GuestResponse` with exit code, output, error.
   - Host reads messages in a loop: log lines → invoke LogWriter; final result → return.

4. **Timeout handling**:
   - Respect context deadline for the overall operation.
   - Set read/write deadlines on the vsock connection from context.

5. **Error handling**:
   - Connection refused (guest not ready) → retry with backoff (max 5 attempts, 100ms initial).
   - Connection reset mid-stream → return error with partial logs.
   - Malformed response → return error with raw data for debugging.

6. **Concurrency safety**: Each `GuestConn` is used by a single goroutine (no shared state needed), but the `DialGuest` function must be safe to call concurrently from different goroutines.

## Implementation Plan

1. Create `api/internal/backend/firecracker/vsock.go`.
2. Implement `DialGuest` with retry logic for connection establishment.
3. Implement `GuestConn` with `SendWorkload`, `ReceiveResult`, `StreamLogs`, `Close`.
4. Implement message type discrimination (log line vs. final result) in the read loop.
5. Unit tests with mock net.Conn to verify protocol handling.

**External Packages**: This task requires research and a guide document for: `mdlayher/vsock`

## Test Plan

- **Connection**: Mock vsock dial; verify retry on connection refused; verify success on eventual connect.
- **Send/Receive round-trip**: Write GuestRequest → read on mock conn → verify bytes match. Write GuestResponse on mock conn → read on client → verify struct equality.
- **Log streaming**: Mock guest sends 5 log lines then final result → verify LogWriter invoked 5 times → verify result returned correctly.
- **Timeout**: Set short context deadline → verify operation returns context.DeadlineExceeded.
- **Error recovery**: Mock connection reset mid-read → verify error returned with descriptive message.

## Verification

- All 23 tests pass with `-race` flag (send/receive, log streaming, connection reset, nil result, unknown type, context cancel, retry with backoff)
- `go vet` clean
- Full project suite passes
- AI review: initial verdict blocked (1 critical) — fixed:
  - Fixed: GuestConn now stores a buffered io.Reader from handshake to prevent protocol desynchronization
  - Fixed: SetDeadline error is now checked
  - Fixed: CONNECT handshake validation checks "OK " prefix (with space)

## Files Modified

- `api/internal/backend/firecracker/vsock.go` — Host-side vsock client: DialGuest, GuestConn, RunWorkload, log streaming
- `api/internal/backend/firecracker/vsock_test.go` — 7 tests covering protocol, streaming, errors, retry
