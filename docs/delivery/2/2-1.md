# [2-1] Backend Interface & Domain Types

[Back to task list](./tasks.md)

## Description

Define the core Go interface and domain types that all isolation backends must implement. This is the foundational contract that makes Firecracker, V8 isolates, and gVisor interchangeable. Create a new `internal/backend/` package with the `Backend` interface, `WorkloadSpec`, `WorkloadResult`, and `BackendCapabilities` types. Add `IsolationAuto = "auto"` to the existing model constants.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 13:14:02 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 13:36:46 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 13:40:14 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 04:43:58 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create `internal/backend/backend.go` with the `Backend` interface:
   - `Execute(ctx context.Context, spec WorkloadSpec) (WorkloadResult, error)` — run a workload
   - `Capabilities() BackendCapabilities` — report what the backend supports
   - `Cleanup(ctx context.Context, workloadID string) error` — clean up resources for a workload
2. Define `WorkloadSpec` struct: workload ID, runtime, isolation, code/input, resource limits (CPU, memory, timeout).
3. Define `WorkloadResult` struct: exit code, output (bytes), error message, duration (ms), log lines.
4. Define `BackendCapabilities` struct: name, supported runtimes ([]string), supported isolations ([]string), max concurrency.
5. Add `IsolationAuto = "auto"` constant to `internal/model/workload.go`.
6. Add package documentation (`doc.go`) for `internal/backend/`.

## Implementation Plan

1. Create `api/internal/backend/` directory.
2. Create `api/internal/backend/doc.go` with package documentation.
3. Create `api/internal/backend/backend.go` with:
   - `Backend` interface (Execute, Capabilities, Cleanup)
   - `WorkloadSpec` struct
   - `WorkloadResult` struct
   - `BackendCapabilities` struct
4. Add `IsolationAuto` constant to `api/internal/model/workload.go`.
5. Write unit tests in `api/internal/backend/backend_test.go` verifying types compile and are usable.

## Test Plan

- TypeScript-equivalent: verify Go compilation passes with all new types.
- Write a test that creates a mock implementation of the `Backend` interface to verify the interface is implementable.
- Verify `IsolationAuto` constant equals `"auto"`.

## Verification

- All tests pass with `-race` flag across all packages.
- `gofmt` compliance verified (no diff).
- Internal AI review passed after resolving formatting and naming findings.
- Mock implementation confirms `Backend` interface is implementable.

## Files Modified

- `api/internal/backend/doc.go` — NEW: package documentation
- `api/internal/backend/backend.go` — NEW: Backend interface, WorkloadSpec, WorkloadResult, BackendCapabilities
- `api/internal/backend/backend_test.go` — NEW: interface implementability, capabilities, error path, cleanup tests
- `api/internal/model/workload.go` — MODIFIED: added `IsolationAuto = "auto"` constant
- `api/internal/model/model_test.go` — MODIFIED: added IsolationAuto to isolation constants test
