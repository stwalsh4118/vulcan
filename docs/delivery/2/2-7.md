# [2-7] Stats Endpoint

[Back to task list](./tasks.md)

## Description

Add the `GET /v1/stats` endpoint that returns aggregate execution statistics: total workload count, counts by status, counts by isolation/backend type, and average execution duration. Wires the store's `GetWorkloadStats` method (from task 2-3) to an API handler.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 13:14:02 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 14:21:21 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 14:23:07 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 04:43:58 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add `GET /v1/stats` route to the API server.
2. Handler calls `store.GetWorkloadStats()` and returns the result as JSON.
3. Response format:
   ```json
   {
     "total": 42,
     "by_status": {"pending": 2, "running": 1, "completed": 35, "failed": 4},
     "by_isolation": {"microvm": 15, "isolate": 20, "gvisor": 7},
     "avg_duration_ms": 1250
   }
   ```
4. Return 200 OK with stats object.
5. Return 500 if store query fails.

## Implementation Plan

1. Create `api/internal/api/stats.go`:
   - `handleGetStats` handler
   - Call `s.store.GetWorkloadStats(r.Context())`
   - Marshal result as JSON response
2. Add route `GET /v1/stats` in `api/internal/api/server.go`.
3. Write unit test for the endpoint.

## Test Plan

- Test endpoint returns 200 with correct JSON structure.
- Test with empty database returns zero counts.
- Test with populated database returns accurate counts and averages.

## Verification

- All tests pass with `-race -count=1` (0 failures)
- `go vet ./...` clean
- `gofmt` clean
- AI review verdict: **pass** (0 critical, 0 high, 0 medium, 1 low)

## Files Modified

- `api/internal/api/stats.go` (new) — handleGetStats handler with statsResponse type
- `api/internal/api/stats_test.go` (new) — empty and populated stats tests
- `api/internal/api/server.go` (modified) — added GET /v1/stats route
