# [2-8] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end tests that verify all 9 acceptance criteria for PBI 2. Tests run against the real compiled binary with a mock/stub backend registered, exercising the full stack from HTTP request through execution engine to response.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 13:14:02 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 14:23:07 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 14:28:01 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 04:43:58 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify each acceptance criterion end-to-end:

1. **AC1**: `Backend` Go interface is defined and documented — verify via compilation and reflection.
2. **AC2**: Workload status transitions are enforced — submit workload, attempt invalid transition via API, verify rejection.
3. **AC3**: `POST /v1/workloads/async` returns 202, workload executes asynchronously — submit and verify immediate 202 response.
4. **AC4**: `GET /v1/workloads/:id` reflects real-time status updates — poll during execution, observe pending→running→completed.
5. **AC5**: `GET /v1/workloads/:id/logs` streams log lines via SSE — connect SSE client, verify log lines arrive during execution.
6. **AC6**: `auto` isolation mode resolves to correct backend — submit with isolation=auto and various runtimes, verify correct backend selected.
7. **AC7**: Timed-out workloads are killed and marked failed — submit with short timeout, verify status becomes failed with timeout error.
8. **AC8**: `GET /v1/backends` returns registered backends and capabilities.
9. **AC9**: `GET /v1/stats` returns aggregate execution statistics.

## Implementation Plan

1. Create a test stub backend that:
   - Implements the `Backend` interface
   - Has configurable delay, output, and error behavior
   - Writes log lines during execution
   - Can be registered with the registry
2. Create `api/test/e2e/pbi2_test.go` with test functions for each AC.
3. Test setup: build binary (or use test server), start with stub backend(s), run against real HTTP endpoints.
4. Use SSE client for log streaming tests.
5. Each test function maps to one acceptance criterion.

## Test Plan

### Objectives
Full end-to-end verification of all PBI 2 acceptance criteria against a running server.

### Environment & Setup
- Build the vulcan binary with a stub backend (or use `httptest` server with stub backend wired in).
- Use temporary SQLite database.
- Register stub backends for all isolation types.

### Test Scenarios
1. **AC1 — Interface defined**: Compile check; stub implements interface without errors.
2. **AC2 — State transitions enforced**: Create workload, attempt status jump (pending→completed), verify 409/error.
3. **AC3 — Async execution**: POST /v1/workloads/async → 202, body contains workload with pending status.
4. **AC4 — Real-time status**: POST async workload (stub has delay), poll GET /:id, observe status progression.
5. **AC5 — SSE log streaming**: POST async workload (stub emits logs), connect to GET /:id/logs, receive log events.
6. **AC6 — Auto routing**: POST with isolation=auto, runtime=node → verify isolate backend used.
7. **AC7 — Timeout enforcement**: POST with timeout_s=1, stub delays 5s → workload fails with timeout.
8. **AC8 — Backends list**: GET /v1/backends → 200, contains registered stub backends with capabilities.
9. **AC9 — Stats**: Execute workloads, GET /v1/stats → 200, counts match.

### Success Criteria
- All 9 tests pass.
- No goroutine leaks (verify with runtime checks or test timeout).
- Server starts and shuts down cleanly.

## Verification

- All 9 AC tests pass with `-race -count=1` (0 failures)
- `go vet ./...` clean
- `gofmt` clean
- AI review verdict: **pass** (0 critical, 0 high, 0 medium after analysis, 3 low)
- Medium findings analyzed: SSE timing (inherent to E2E async testing, 200ms delay is practical), stats isolation (each test uses own server — false positive)

## Files Modified

- `api/test/e2e/pbi2_test.go` (new) — 9 E2E tests covering all PBI 2 acceptance criteria
