# [2-2] Workload State Machine

[Back to task list](./tasks.md)

## Description

Implement state transition validation for workloads so that only valid status changes are permitted. The valid transitions are: pending→running, running→completed, running→failed, running→killed. Add a `ValidTransition(from, to string) bool` function to the model package and enforce it in the store's `UpdateWorkloadStatus` method. Invalid transitions must return a descriptive error.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 13:14:02 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Define the set of valid state transitions as a package-level data structure in the model package.
2. Add `ValidTransition(from, to string) bool` function to `internal/model/`.
3. Add `ErrInvalidTransition` sentinel error to `internal/store/`.
4. Enforce transition validation in `SQLiteStore.UpdateWorkloadStatus()` — fetch current status, validate transition, reject if invalid.
5. The existing `DELETE /v1/workloads/:id` handler sets status to `killed` — this must continue to work for workloads in `pending` or `running` state.

## Implementation Plan

1. Add valid transitions map to `api/internal/model/workload.go`:
   - pending → running
   - running → completed, failed, killed
   - pending → killed (to support DELETE)
2. Add `ValidTransition()` function to `api/internal/model/workload.go`.
3. Add `ErrInvalidTransition` to `api/internal/store/store.go`.
4. Update `SQLiteStore.UpdateWorkloadStatus()` to:
   - Read current status within a transaction
   - Call `ValidTransition(current, new)`
   - Return `ErrInvalidTransition` if invalid
5. Update workload handler for DELETE to return 409 Conflict for invalid transitions.
6. Write unit tests for transition validation logic and store enforcement.

## Test Plan

- Unit test `ValidTransition()` with all valid transitions (should return true).
- Unit test `ValidTransition()` with invalid transitions (e.g., completed→running, failed→pending) — should return false.
- Integration test: create workload (pending), update to running (success), update to completed (success).
- Integration test: create workload (pending), update to completed directly (should fail with ErrInvalidTransition).
- Integration test: verify DELETE on a completed workload returns an error.

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
