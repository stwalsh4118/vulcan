# [2-3] Store Extensions for Execution

[Back to task list](./tasks.md)

## Description

Extend the Store interface with methods needed for workload execution: `UpdateWorkload` for full workload updates (output, exit code, duration, error, timestamps) and `GetWorkloadStats` for aggregate statistics. Implement both in the SQLite store.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 13:14:02 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 13:44:43 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 13:48:04 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 04:43:58 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add `UpdateWorkload(ctx context.Context, w *model.Workload) error` to the Store interface — updates all mutable fields (status, output, exit_code, error, duration_ms, started_at, finished_at).
2. Add `GetWorkloadStats(ctx context.Context) (*WorkloadStats, error)` to the Store interface — returns aggregate counts by status and by backend/isolation, plus average duration.
3. Define `WorkloadStats` struct in the store package with: total count, counts per status, counts per isolation type, average duration (ms).
4. Implement both methods in `SQLiteStore`.
5. Ensure `UpdateWorkload` also validates state transitions (reuse logic from task 2-2).

## Implementation Plan

1. Define `WorkloadStats` struct in `api/internal/store/store.go`.
2. Add `UpdateWorkload` and `GetWorkloadStats` to the `Store` interface.
3. Implement `UpdateWorkload` in `api/internal/store/sqlite.go`:
   - Validate state transition if status changed
   - UPDATE all mutable fields by ID
   - Return `ErrNotFound` if no rows affected
4. Implement `GetWorkloadStats` in `api/internal/store/sqlite.go`:
   - Query counts grouped by status
   - Query counts grouped by isolation
   - Query average duration of completed workloads
5. Write unit tests for both methods.

## Test Plan

- Test `UpdateWorkload`: create a workload, update all fields, verify retrieval shows new values.
- Test `UpdateWorkload` with non-existent ID returns `ErrNotFound`.
- Test `UpdateWorkload` with invalid status transition returns `ErrInvalidTransition`.
- Test `GetWorkloadStats`: insert multiple workloads with various statuses, verify counts and averages are correct.
- Test `GetWorkloadStats` on empty database returns zero counts.

## Verification

- All tests pass with `-race` flag.
- UpdateWorkload validates state transitions and updates all mutable fields correctly.
- GetWorkloadStats returns accurate aggregate counts within a read-only transaction.
- Empty database returns zero-valued stats.

## Files Modified

- `api/internal/store/store.go` — MODIFIED: added `WorkloadStats` struct, `UpdateWorkload` and `GetWorkloadStats` to Store interface
- `api/internal/store/sqlite.go` — MODIFIED: implemented `UpdateWorkload` and `GetWorkloadStats`
- `api/internal/store/sqlite_test.go` — MODIFIED: added tests for both new methods including error and edge cases
