# [9-5] Frontend Historical Log Viewing

[Back to task list](./tasks.md)

## Description

Update the frontend to detect whether a workload is in a terminal state and fetch persisted logs from the history API endpoint instead of attempting SSE streaming. Update the LogViewer component to show appropriate status indicators for historical vs. live logs. Handle the seamless transition from live streaming to historical display when a workload completes while the user is watching.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 07:13:41 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 07:31:56 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 07:36:52 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 07:57:42 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **useLogStream hook** (`web/src/hooks/useLogStream.ts`):
   - For terminal workloads: fetch from `GET /api/v1/workloads/:id/logs/history` instead of opening an EventSource.
   - Return fetched log lines in the same `lines` array format.
   - Add a new stream state value (e.g., `"historical"`) to distinguish from live streaming.
   - Handle transition: if workload becomes terminal while SSE is active, close SSE and fetch full history to ensure no lines were missed.
2. **LogViewer component** (`web/src/components/logs/LogViewer.tsx`):
   - For `"historical"` stream state: show indicator like "Complete — N log lines" instead of "Disconnected".
   - Remove the "Disconnected" message for terminal workloads that have historical logs.
   - Log viewer appearance (monospace, dark theme, scrolling) remains identical for both modes.
3. **API client**: Add a function to call the history endpoint (in the existing API utility layer or inline in the hook).

## Implementation Plan

1. Add `"historical"` to the `LogStreamState` type in the hook file.
2. Update `useLogStream`:
   - Check if status is terminal on mount — if so, call the history endpoint via `fetch()`.
   - Parse the JSON response and set `lines` from the `lines` array.
   - Set `streamState` to `"historical"`.
   - Add an effect that watches `status`: when it transitions to terminal while SSE is active, close EventSource, fetch full history, set state to `"historical"`.
3. Update `LogViewer`:
   - Add a case for `"historical"` in the status indicator — show a gray/blue dot with "Complete — {lines.length} log lines".
   - Change empty state for terminal workloads from "No logs available" to check if historical fetch is in progress.
4. Verify with Playwright MCP tools:
   - Submit a workload, wait for completion, navigate to detail page — logs should show.
   - Watch a workload in real-time, wait for it to complete — transition should be seamless.

## Test Plan

### Objectives
Verify the frontend correctly displays persisted logs for terminal workloads and handles the live-to-historical transition.

### Key Scenarios
1. **Terminal workload on page load** — navigating to a completed workload's detail page fetches and displays historical logs.
2. **Live-to-historical transition** — watching a running workload in real-time; when it completes, logs transition seamlessly to historical view without gaps.
3. **Status indicator** — shows "Complete — N log lines" for historical mode, "Streaming" for live mode.
4. **No logs** — terminal workload with zero log lines shows appropriate empty state.

### Success Criteria
- Historical logs display correctly for completed/failed/killed workloads.
- No "Disconnected" message shown when historical logs are available.
- Live streaming continues to work unchanged for active workloads.

## Verification

- `pnpm build` passes.
- `pnpm lint` passes (0 errors).
- TypeScript compilation clean.
- Historical mode shows "Complete — N log lines" with blue indicator.
- No "Disconnected" message for terminal workloads.

## Files Modified

- `web/src/lib/types.ts` — Added `LogHistoryLine`, `LogHistoryResponse` interfaces.
- `web/src/lib/api.ts` — Added `getLogHistory()` function.
- `web/src/hooks/useLogStream.ts` — Rewritten with dual-effect pattern: SSE for active, history fetch for terminal.
- `web/src/components/logs/LogViewer.tsx` — Added `"historical"` state, blue dot indicator, dynamic label.
