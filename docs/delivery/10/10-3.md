# 10-3: Update useLogStream Hook for Clean Shutdown

[Back to task list](./tasks.md)

## Description

The `useLogStream` hook (`web/src/hooks/useLogStream.ts`) blindly reconnects up to 3 times when `onerror` fires, which happens both on real errors AND when the server closes the stream on workload completion. Update the hook to listen for the `event: done` SSE event and close the `EventSource` cleanly, without triggering reconnect logic.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:20:23 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-20 08:40:14 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-20 08:42:10 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |

## Requirements

1. Add an event listener for the `done` event type on the `EventSource` instance (using `es.addEventListener("done", ...)`).
2. When the `done` event is received:
   - Close the `EventSource` cleanly.
   - Set stream state to `"closed"`.
   - Do NOT trigger reconnect logic.
3. In the `onerror` handler, only attempt reconnect if the `done` event was NOT previously received for this connection.
4. The existing historical log fallback (fetch from `/logs/history` when status becomes terminal) must continue to work.
5. Clean up the `done` event listener on unmount.

## Implementation Plan

1. Add a `doneReceivedRef` (`useRef<boolean>(false)`) to track whether the `done` event was received.
2. Reset `doneReceivedRef` to `false` at the start of each `connect()` call.
3. Add `es.addEventListener("done", ...)` in the `connect()` function:
   - Set `doneReceivedRef.current = true`.
   - Call `es.close()`.
   - Set `eventSourceRef.current = null`.
   - Set stream state to `"closed"`.
4. In the `onerror` handler, check `doneReceivedRef.current` — if `true`, skip reconnect and just return.
5. Verify the historical log fallback effect still triggers when `isTerminal` becomes `true`.

## Test Plan

- Verify TypeScript compilation passes.
- Browser-based verification (Playwright) will be covered in task 10-4.
- Manual verification: run a workload, observe that the stream closes cleanly after `done` event, no reconnect attempts in the console/network tab.

## Verification

- `npx tsc --noEmit` — passes
- `pnpm lint` — passes
- Internal AI review: pass (0 critical, 0 high, 0 medium, 2 low)

## Files Modified

- `web/src/hooks/useLogStream.ts` — Added `doneReceivedRef`, done event listener, onerror guard
