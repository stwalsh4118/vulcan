# 10-2: Create Next.js Streaming API Route for SSE Proxy

[Back to task list](./tasks.md)

## Description

The Next.js `rewrites()` proxy in `next.config.ts` buffers the entire upstream SSE response, preventing real-time log streaming to the browser. Replace the proxy path for the SSE endpoint with a custom Next.js App Router API route handler that fetches the upstream SSE stream from the Go backend and pipes it to the client as a `ReadableStream`, enabling true streaming without buffering.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:20:23 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-20 08:37:37 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-20 08:40:14 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 16:15:39 | Status Change | Review | Done | Task completed and verified; next.config.ts fallback rewrite fix applied | AI_Agent |

## Requirements

1. Create a new Next.js API route at `web/src/app/api/v1/workloads/[id]/logs/route.ts`.
2. The route handler must:
   - Fetch the upstream SSE stream from `http://localhost:8080/v1/workloads/{id}/logs`.
   - Pipe the response body (`ReadableStream`) directly to the client without buffering.
   - Set correct SSE headers: `Content-Type: text/event-stream`, `Cache-Control: no-cache`, `Connection: keep-alive`.
   - Forward upstream error status codes (404, 500) to the client.
3. Next.js API routes take precedence over `rewrites()`, so the existing rewrite config does not need modification. The catch-all rewrite continues handling all non-SSE API paths.
4. Set `export const dynamic = "force-dynamic"` to prevent Next.js from caching the route.
5. The Go backend URL should use a constant (not hardcoded inline).

## Implementation Plan

1. Create directory `web/src/app/api/v1/workloads/[id]/logs/`.
2. Create `route.ts` with a `GET` handler:
   - Extract `id` from route params.
   - Fetch from `http://localhost:8080/v1/workloads/${id}/logs` with appropriate headers.
   - If upstream response is not OK, forward the status and body.
   - If upstream response is OK, return a new `Response` with `upstream.body` as the body and SSE headers.
3. Export `dynamic = "force-dynamic"` to disable caching.

## Test Plan

- Start both the Go backend and Next.js dev server.
- Use `curl -N http://localhost:3000/api/v1/workloads/<id>/logs` and verify log lines stream in real time (not batched).
- Verify that non-SSE API paths (e.g., `/api/v1/workloads`) still work through the rewrite proxy.
- Full browser-based verification will be covered in task 10-4 (E2E CoS Test).

## Verification

- `npx tsc --noEmit` — passes
- `pnpm lint` — passes
- Internal AI review: pass (0 critical, 0 high, 1 medium deferred — DRY for backend URL out of scope, 4 low)

## Files Modified

- `web/src/app/api/v1/workloads/[id]/logs/route.ts` (new) — Streaming SSE proxy route handler
- `web/next.config.ts` — Changed `rewrites()` to return `{ fallback: [...] }` so route handlers take precedence over catch-all proxy
