# 10-1: Add `event: done` SSE Termination to Go Backend

[Back to task list](./tasks.md)

## Description

The Go SSE handler (`api/internal/api/logs.go`) currently closes the stream without sending any termination signal when a workload finishes. The browser `EventSource` API interprets this as an error (fires `onerror`), which triggers reconnect logic in the frontend. Fix this by sending an explicit `event: done` SSE event before closing the stream, and update the API spec to document the new event type.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:20:23 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. When the broker channel closes (workload finished), send an `event: done` SSE event with `data: stream complete` before returning from `handleStreamLogs`.
2. When the client disconnects (`r.Context().Done()`), do NOT send the `done` event — just return.
3. The `done` event must use the SSE named event format: `event: done\ndata: stream complete\n\n`.
4. Update `docs/api-specs/core/core-api.md` to document the `done` event type in the `GET /v1/workloads/:id/logs` section.
5. All existing Go E2E tests must continue to pass.

## Implementation Plan

1. In `api/internal/api/logs.go`, add a `writeSSEEvent` helper function that writes a named SSE event (`event: <type>\ndata: <data>\n\n`).
2. In the `handleStreamLogs` function, when `ch` is closed (`!ok`), call the new helper to send `event: done` with `data: stream complete` before returning.
3. Update `docs/api-specs/core/core-api.md`:
   - Add `event: done` documentation to the `GET /v1/workloads/:id/logs` section.
   - Specify that `done` is sent once when the workload reaches terminal state, before the stream closes.
   - Note that regular log lines are unnamed events (just `data:` lines).

## Test Plan

- Run existing Go E2E tests (`go test ./test/e2e/...`) to verify no regressions.
- Verify `TestPBI9_AC4_SSEStreamingUnchanged` still passes — the test reads `data:` lines and the new `event: done` line uses `event:` prefix so it won't interfere.
- The `done` event will be thoroughly tested in task 10-4 (E2E CoS Test).

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation._
