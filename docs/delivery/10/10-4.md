# 10-4: E2E CoS Test — Real-Time Streaming and Clean Shutdown

[Back to task list](./tasks.md)

## Description

End-to-end tests verifying that all PBI-10 acceptance criteria are met: real-time log delivery through the full stack, explicit `done` event from the backend, clean connection teardown in the frontend, and no regressions to existing functionality.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:20:23 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Go E2E test: verify `event: done` is sent as the final SSE event before stream closure.
2. Go E2E test: verify log lines arrive incrementally via SSE (not batched at end).
3. Go E2E test: verify SSE stream for already-terminal workloads returns empty stream (existing behavior preserved).
4. All existing Go E2E tests pass without modification.
5. All existing Playwright E2E tests pass without modification.
6. Historical log fallback (PBI-9) continues to work.

## Implementation Plan

1. **Go E2E tests** (`api/test/e2e/pbi10_test.go`):
   - `TestPBI10_AC2_DoneEventSentOnCompletion`: Submit async workload, connect to SSE, read all events, verify the final event is `event: done` with `data: stream complete`.
   - `TestPBI10_AC2_DoneEventFormat`: Verify the `done` event follows SSE named event format (`event: done\ndata: stream complete\n\n`).
   - `TestPBI10_TerminalWorkloadNoDoneEvent`: Connect to SSE for an already-completed workload, verify empty stream with no `done` event (stream was never active).
   - `TestPBI10_IncrementalDelivery`: Submit a workload with multiple log lines and delay, connect to SSE, verify lines arrive one at a time (not all at once after completion).
2. **Run existing tests**:
   - `go test ./test/e2e/...` — all existing Go E2E tests pass.
   - `pnpm exec playwright test` — all existing Playwright tests pass.

## Test Plan

### Objectives
Verify all PBI-10 acceptance criteria are met end-to-end.

### Test Scope
- Go backend SSE behavior (done event, incremental delivery)
- Regression testing of existing E2E suites

### Key Scenarios

| # | Scenario | Expected Result |
|---|----------|-----------------|
| 1 | SSE stream for active workload ends with `event: done` | Final event before stream close is `event: done` |
| 2 | SSE log lines arrive incrementally | Lines received before workload completes |
| 3 | SSE for terminal workload returns empty stream | No events, no `done` event |
| 4 | Existing Go E2E tests pass | All PBI-1, PBI-2, PBI-4, PBI-9 tests green |
| 5 | Existing Playwright tests pass | All PBI-3, PBI-4, PBI-9 frontend tests green |
| 6 | Historical logs still work after completion | `/logs/history` returns correct lines |

### Success Criteria
- All new E2E tests pass.
- All existing E2E tests pass without modification.
- No regressions in log streaming or historical log behavior.

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation._
