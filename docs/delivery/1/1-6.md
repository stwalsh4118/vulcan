# [1-6] Health & Metrics Endpoints

[Back to task list](./tasks.md)

## Description

Implement `GET /healthz` returning server health status and `GET /metrics` serving Prometheus-formatted metrics. These are operational endpoints required by the acceptance criteria.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 11:12:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:36:10 | Status Change | Proposed | Agreed | User requested PBI implementation | AI_Agent |
| 2026-02-18 11:36:10 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 11:39:59 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 11:58:00 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. `GET /healthz` returns HTTP 200 with JSON body: `{"status": "ok"}`.
2. `GET /metrics` returns Prometheus text format metrics via `promhttp.Handler()`.
3. Register basic metrics:
   - `vulcan_http_requests_total` (counter, labels: method, path, status)
   - `vulcan_http_request_duration_seconds` (histogram, labels: method, path)
4. Add metrics collection middleware that increments these counters on every request.
5. Endpoints registered on the server router from task 1-5.

## Implementation Plan

1. Create `internal/api/health.go` with `handleHealthz` returning `{"status": "ok"}`.
2. Create `internal/api/metrics.go` defining Prometheus metrics variables and a middleware function that records request count and duration.
3. Register `/healthz` and `/metrics` routes in `NewServer`.
4. Add the metrics middleware to the middleware stack.
5. Run `go get github.com/prometheus/client_golang`.

**External Packages**: This task requires research and a guide document for: `github.com/prometheus/client_golang`

## Test Plan

- `GET /healthz` returns 200 with `{"status": "ok"}`.
- `GET /metrics` returns 200 with content-type containing `text/plain` (Prometheus format).
- After making requests, `/metrics` output includes `vulcan_http_requests_total` and `vulcan_http_request_duration_seconds`.

## Verification

- `go build ./cmd/vulcan` succeeds.
- `go vet ./...` passes.
- All 5 API tests pass: healthz returns `{"status":"ok"}`, metrics contains `vulcan_http_requests_total` and `vulcan_http_request_duration_seconds`.

## Files Modified

- `api/internal/api/health.go` — GET /healthz handler
- `api/internal/api/metrics.go` — Prometheus metrics, middleware, /metrics handler
- `api/internal/api/server.go` — Added metrics middleware, route registration
- `api/internal/api/health_test.go` — Tests for /healthz and /metrics
- `api/go.mod` / `api/go.sum` — Added prometheus/client_golang dependency
- `docs/delivery/1/1-6-prometheus-guide.md` — External package research guide
