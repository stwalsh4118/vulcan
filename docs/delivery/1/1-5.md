# [1-5] HTTP Server with chi & Middleware

[Back to task list](./tasks.md)

## Description

Set up the chi HTTP router with middleware (request ID, structured logging, panic recovery, CORS) and implement graceful shutdown. This creates the server skeleton that endpoints register on.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 11:12:42 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. `internal/api/server.go` — `Server` struct wrapping `*chi.Mux` and dependencies (store, logger, config).
2. `NewServer(cfg, store, logger) *Server` constructor that configures the router and middleware.
3. Middleware stack (in order): request ID, structured logger (logs method, path, status, duration), panic recovery, CORS.
4. `Run() error` method that starts `http.Server` on the configured listen address with graceful shutdown on SIGINT/SIGTERM.
5. Update `cmd/vulcan/main.go` to create the server (with store from 1-4, config from 1-2, logger from 1-2) and call `Run()`.
6. CORS configured to allow all origins for development (tightened in later PBIs if needed).

## Implementation Plan

1. Create `internal/api/server.go` with `Server` struct.
2. In `NewServer`, create `chi.NewRouter()`, add middleware: `chi/middleware.RequestID`, custom logging middleware using slog, `chi/middleware.Recoverer`, `cors.Handler`.
3. Implement `Run()` with `http.Server{Addr, Handler}`, signal handling via `os/signal`, graceful `Shutdown(ctx)` with timeout.
4. Update `main.go`: load config → init logger → open store → create server → run.
5. Run `go get github.com/go-chi/chi/v5 github.com/go-chi/cors`.

**External Packages**: This task requires research and a guide document for: `github.com/go-chi/chi/v5`

## Test Plan

- Server starts and listens on configured address.
- Requests include a `X-Request-Id` header in response.
- Panic in a handler returns 500 instead of crashing the process.
- CORS headers present in responses.
- Server shuts down gracefully on SIGINT (no connection drops during shutdown).

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
