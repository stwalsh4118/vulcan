# [1-8] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that all PBI 1 Conditions of Satisfaction are met. Start the server, exercise every acceptance criterion, and document results.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 11:12:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:43:43 | Status Change | Proposed | Agreed | User requested PBI implementation | AI_Agent |
| 2026-02-18 11:43:43 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 11:48:54 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 11:58:00 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify each of the 9 PBI 1 acceptance criteria:

1. `go build ./cmd/vulcan` produces a single binary that starts an HTTP server.
2. `GET /healthz` returns 200 with server status.
3. `GET /metrics` returns Prometheus-formatted metrics.
4. `POST /v1/workloads` accepts a request body and stores it (returns 201, status `pending`).
5. `GET /v1/workloads/:id` retrieves a stored workload by ID.
6. `GET /v1/workloads` lists workloads with pagination.
7. `DELETE /v1/workloads/:id` marks a workload as killed.
8. Structured JSON logs written to stdout on every request.
9. Server configurable via env vars (listen address, DB path).

## Implementation Plan

1. Write an E2E test file (`test/e2e/pbi1_test.go`) that:
   - Builds the binary.
   - Starts the server as a subprocess with custom env vars (verifying criterion 9).
   - Captures stdout to verify JSON log output (criterion 8).
   - Runs HTTP requests against each endpoint (criteria 2-7).
   - Tears down the server.
2. Each acceptance criterion maps to one or more test assertions.
3. Test uses `os/exec` to start the binary and `net/http` for requests.
4. Includes a helper to wait for the server to be ready (poll `/healthz`).

## Test Plan

### Objectives
Full end-to-end verification of PBI 1 CoS — the server is tested as a black box.

### Environment & Setup
- Build binary from source.
- Start server on a random available port via `VULCAN_LISTEN_ADDR=:0` or a known test port.
- Use a temp directory for `VULCAN_DB_PATH`.

### Key Scenarios (mapped to acceptance criteria)

| # | Acceptance Criterion | Test |
|---|---------------------|------|
| 1 | Binary builds and starts | `go build` succeeds; subprocess starts and responds to healthz |
| 2 | GET /healthz → 200 | HTTP GET, assert 200 + `{"status": "ok"}` |
| 3 | GET /metrics → Prometheus | HTTP GET, assert 200 + contains `vulcan_` metrics |
| 4 | POST /v1/workloads → 201 | POST valid body, assert 201 + returned workload has `pending` status |
| 5 | GET /v1/workloads/:id → workload | GET the ID from step 4, assert fields match |
| 6 | GET /v1/workloads → paginated list | Create multiple workloads, GET with limit/offset, verify pagination |
| 7 | DELETE /v1/workloads/:id → killed | DELETE the workload, assert status `killed` |
| 8 | Structured JSON logs | Capture subprocess stdout, parse as JSON lines, verify fields present |
| 9 | Env var configuration | Server started with custom env vars; verify it uses them (different port, different DB path) |

### Success Criteria
- All 9 acceptance criteria verified with passing assertions.
- No flaky behavior — test is deterministic.

## Verification

- All 9 E2E tests pass, one per acceptance criterion.
- All 33 tests pass across all packages.
- Binary builds, starts, serves all endpoints, logs structured JSON, and is configurable via env vars.

## Files Modified

- `api/test/e2e/pbi1_test.go` — E2E tests covering all 9 PBI 1 acceptance criteria
