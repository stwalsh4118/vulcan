# [1-7] Workload API Endpoints

[Back to task list](./tasks.md)

## Description

Implement the four workload CRUD endpoints: create, get by ID, list with pagination, and delete (kill). These form the core API surface that frontends and CLIs target.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 11:12:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:39:59 | Status Change | Proposed | Agreed | User requested PBI implementation | AI_Agent |
| 2026-02-18 11:39:59 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 11:43:43 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 11:58:00 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **`POST /v1/workloads`** — Create a workload:
   - Accepts JSON body with: `runtime`, `isolation` (optional, default from auto-routing later), `code` (string), `input` (any JSON), `resources` (`cpus`, `mem_mb`, `timeout_s`).
   - Validates required fields (`runtime` is mandatory).
   - Generates ULID, sets status to `pending`, sets `created_at`.
   - Stores in SQLite via the store interface.
   - Returns 201 with the full workload record as JSON.
   - Note: No actual execution yet — workload stays `pending` (backends come in PBI 2+).

2. **`GET /v1/workloads/:id`** — Get a workload by ID:
   - Returns 200 with workload JSON.
   - Returns 404 if not found.

3. **`GET /v1/workloads`** — List workloads:
   - Query params: `limit` (default 20, max 100), `offset` (default 0).
   - Returns 200 with JSON: `{"workloads": [...], "total": N, "limit": L, "offset": O}`.

4. **`DELETE /v1/workloads/:id`** — Kill a workload:
   - Sets status to `killed` and `finished_at` to now.
   - Returns 200 with updated workload.
   - Returns 404 if not found.

5. All endpoints return structured JSON error responses on failure: `{"error": "<message>"}`.
6. Request/response JSON field names use `snake_case` matching the PRD examples.

## Implementation Plan

1. Create `internal/api/workload.go` with handler methods on `Server`.
2. Define request/response structs with JSON tags.
3. Implement `handleCreateWorkload`:
   - Decode request body, validate `runtime` field.
   - Build `model.Workload` with `NewID()`, status `pending`, `created_at` = now.
   - Map `resources` to `CPULimit`, `MemLimit`, `TimeoutS` fields.
   - Call `store.CreateWorkload`, return 201 with workload JSON.
4. Implement `handleGetWorkload`:
   - Extract `:id` from URL via `chi.URLParam`.
   - Call `store.GetWorkload`, return 200 or 404.
5. Implement `handleListWorkloads`:
   - Parse `limit`/`offset` query params with defaults and bounds.
   - Call `store.ListWorkloads`, return wrapped response.
6. Implement `handleDeleteWorkload`:
   - Extract `:id`, call `store.UpdateWorkloadStatus(id, "killed")`.
   - Return updated workload or 404.
7. Register routes under `/v1/workloads` in `NewServer`.

## Test Plan

### Objectives
Verify all four endpoints handle valid requests, invalid requests, and edge cases correctly.

### Test Scope
- Integration tests using `httptest.Server` with a real SQLite store (in-memory).

### Key Scenarios

**POST /v1/workloads:**
1. Valid request → 201, response has ULID `id`, status `pending`, correct fields.
2. Missing `runtime` → 400 with error message.
3. Invalid JSON body → 400.

**GET /v1/workloads/:id:**
4. Existing workload → 200 with correct data.
5. Non-existent ID → 404 with error.

**GET /v1/workloads:**
6. Empty DB → 200 with `{"workloads": [], "total": 0}`.
7. Multiple workloads → pagination with limit/offset works.
8. Default limit applied when not specified.

**DELETE /v1/workloads/:id:**
9. Existing workload → 200, status now `killed`, `finished_at` set.
10. Non-existent ID → 404.

### Success Criteria
- All endpoints return correct status codes and JSON structures.
- Pagination math is correct.
- Error responses follow the `{"error": "..."}` format.

## Verification

- `go build ./cmd/vulcan` succeeds.
- `go vet ./...` passes.
- All 15 API tests pass (5 existing + 10 new workload tests).
- All 24 tests pass across all packages.

## Files Modified

- `api/internal/api/workload.go` — Create, Get, List, Delete handlers + helpers
- `api/internal/api/workload_test.go` — Integration tests for all 4 endpoints
- `api/internal/api/server.go` — Added /v1/workloads route group
